## 200421 개발 3주차 자료
#### 3 주차 목표 : 1:N Model 연결/ 여러 app 연결/ 코드의 재사용 / Git
- 1 여러개의 app의 url 관리하기 위해 include
- 2 Model의 1:N 관계(foreing key) PK(Primory key)기본 의   이해
- 3 코드의 재사용
- 3 form으로 사용자 입력받고 DB에 저장하기

### 1 간단한 아주대 멋사8기 블로그를 만들어 볼게용

2주차에 model을 migrate해서 DB를 만들어주고 Data를 생성한 후 view로 처리해준 뒤 html로 보내봤죠?<br/>
app을 하나 더 만들어주고 model을 만들어 준 뒤 기존의 모델과 연결시키고, 앱의 url을 프로젝트에 연결해볼게요<br/>

#### 1) 앱 만들기
```
/project 위치

python manage.py startapp post
```
#### 2) settings.py에 앱 등록해주기
```python

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'myapp',
    'post',
]
```
#### 3) post앱에 urls.py 만들기
```python
from django.urls import path
import post.views

urlpatterns = [
    path('', post.views.post_list, name = 'post_list'), 
    #''(공백) url이 들어오면 post_list 함수를 호출한다
]
```
#### 4) myproject urls에서 post/urls.py 연결해주기
```python
from django.contrib import admin
from django.urls import path, include   # include import 해주기
import myapp.views

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', myapp.views.index, name = 'home'),
    path('lions/', myapp.views.lion_list, name = 'lions'),
    path('post/', include('post.urls')) 
    # post.urls를 include 해주는데 처음 url이 `post/` 가 된다   
]
```
나중엔 기능별로 앱이 생길텐데 project/urls.py에 모든 path를 관리하면 보기 안좋겠죠?<br/>
그래서 보통 app에다가 urls.py 를 만들어 주고 project/urls.py와 연결해줍니다<br/>
#### 5) 이제 post/views.py에 함수를 작성하고 templates/post.html을 만들어줄게요
![캡처](https://user-images.githubusercontent.com/48672212/79643223-f0258380-81dc-11ea-8519-f1c536d99dc3.JPG)
<br/>
```python
# post/views.py
from django.shortcuts import render

def post_list(request):

    return render(request, 'post.html')
```
```html
<!-- templates/post.html --!>

<h2>하위</h2>
```
그리고 runserver를 돌려서 url 뒤에 /post를 쳐주면`하위가 나오죠?`<br/>
post/urls.py와 myproject/urls.py에서 처리해준것 같이 post.html을 요청해줍니다<br/>
이제 post 앱에도 model을 만들고 makemigrations -> migrate 해서 DB를 만들어줄게요 <br/>
#### 6) post앱에 model 만들기
```python
# post/models.py

from django.db import models
from django.utils import timezone

# Create your models here.

class Post(models.Model):
    title = models.CharField(max_length = 100)      # 제목
    content = models.TextField(max_length = 200)    # 내용
    create_data = models.DateTimeField(default = timezone.now)
    objects = models.Manager()  # 저번시간에 말해준 Manager인데 다시한번 집고 넘어가
    
    def __str__(self):    # 얘는 데이터 생성 시 생성값을 title 칼럼으로 해준다는 것
        return str(self.title)
```
`python manage.py makemigrations`랑`python manage.py migrate`ㄱㄱ<br/><br/>
아 근데 해주고 싶은게 있어요<br/>
저번에 Lion 모델에서 생성한 객체들이 이 Post 모델을 이용해서 글을 작성하게 하고 싶어요<br/>
보통 한 사람이 여러개의 글을 작성하죠 ? <br/>
그러려면 Lion 모델과 Post 모델을 1 : N으로 묶어주면 됩니다 <br/><br/>
`뭔소리야?`<br/><br/>
![sag](https://user-images.githubusercontent.com/48672212/79643539-5e1e7a80-81de-11ea-94e0-ec315176803c.JPG)
<br/>
저번에 이렇게 Lion 모델을 만들어 줬죠? Post 모델도 똑같아요<br/>
![asgsag](https://user-images.githubusercontent.com/48672212/79643642-ef8dec80-81de-11ea-842c-b7476d193ec6.JPG)
<br/>
Post 모델도 이렇게 만들어지는데 아까 뭐라그랬죠?<br/>
한 사람이 여러개의 글을 쓰도록 만들게 하자고 했죠 ? <br/>
<br/>
![agsageg](https://user-images.githubusercontent.com/48672212/79643732-4d223900-81df-11ea-8471-832c13b6e890.JPG)
<br/>
이렇게 Post모델에 최광일 소유를 부여해서 여러개의 글을 작성하도록 할 수 있어요<br/>
Post 모델에 뭐가 추가됬죠 ? 최광일이가 추가됬죠? 그럼 Post 모델에 name 칼럼을 추가하면 되겠네요?
#### 7 FK(Forein key)로 1 : N Model 연결
```python
# post/models.py

class Post(models.Model):
    name = models.ForeignKey (Lion, on_delete=models.CASCADE)   # 추가
    title = models.CharField(max_length = 100)
    content = models.TextField(max_length = 200)
    create_data = models.DateTimeField(default = timezone.now)
    objects = models.Manager()
    
    def __str__(self):
        return str(self.title)
```
1 : N 관계로 모델을 묶을때는 이렇게 models.ForeignKey 를 사용해줍니다<br/><br/>
`왜냐구요 ? django한테 물어보세요 걔가 Class로 만들어논거에요...`<br/><br/>
근데 뒤에 뭐가 붙었죠 ? ForeignKey field 값엔 여러가지가 있는데 2가지만 알아볼게여 <br/>
먼저 ForeignKey 에는 Post모델과 연결해줄 모델(Lion)을 연결해주고 on_delete라는 걸 해주는데 <br/><br/>
lion 한명이 여러 post를 작성할 수 있다고 했죠 ? 근데 lion 한명의 데이터를 지우면 걔가 작성한 <br/>
post 모델의 데이터들은 어떻게 될까요 ? 상식적으로 없어져야겟죠 ? <br/>
그런데 장고는 인간이 아니라서 그걸 알려줘야 하는데 그게 `on_delete=models.CASCADE` 입니다.
<br/>
<br/>
그러면 이제 admin에서 post data를 만들고 view를 통해 templates으로 넘겨줘볼게요<br/>
우선 모든 post를 가져와서 render 시켜볼게요 <br/>
#### 8) views.py and templates
```python
# post/views.py

from django.shortcuts import render
from post.models import Post    # post모델 임포트

# Create your views here.

def post_list(request):

    post_list = Post.objects.all()  # Post 모델에있는 객체 다 가져와

    return render(request, 'post.html', {'post_list' : post_list})  # 변수 넘겨줘
```
```html
<!-- post/templates/post.html --!>

{% if post_list %}                              <!-- 작성한 글이 있다면 --!>
        {% for post in post_list %}             <!-- for 문 돌려 --!>
        <div class = "post">
            <div class = "post_container">
                <div class = "post_header">
                    <h2>{{post.pk}}번째 포스트 입니다</h2>
                    <p>작성자 : {{post.name}}<p>    
                </div>
                <div class = "post_center">
                    <p>제목 : {{post.title}}</p>
                    <p>내용 : {{post.content}}</p>
                </div>
                <div class = "post_bottom">
                    <p>작성시각 : {{post.create_data}}</p>
                </div>
            </div>
        </div>
        {% endfor %}                            <!-- for 문 끝 --!>
    {% else %}                                  <!-- 작성한 글이 없다면 --!>
        <h2>작성된 Post가 없습니다</h2>
{% endif %}                                     <!-- if 끝 --!>
```
좋아요 이러면 모든 lion 객체가 작성한 글들이 불러와질꺼에요<br/>
근데 저는 한 사람이 작성한 글만 보고싶어요 그러면 어떡해야할까요? <br/>
#### 9) url path 에서 views.py로 변수 넘겨주기
최광일이 작성한 글만 보고싶어요, 그러면 views에서 데이터(post_list)만 처리해 주면 될까요? 해보죠
```python
# myproject/views.py

def post_list(request):
    
    post_list = Post.objects.all().filter(name = '최광일')
    
    return render(request, 'lion_posts.html', {
        'post_list' : post_list,
        })
```
이렇게 데이터에서 name이 최광일인 것을 filter 해주면 될까요? 맞습니다<br/>
근데 filter하고 싶은 name이 최광일 이라는걸 django가 어떻게 알죠?<br/>
즉 name이 최광일, 박규리 등등..이렇게 바뀔텐데 말이죠!<br/><br/>

그러면 사람별로 html과 url, views.py 에서 함수 처리해줘야 할까요? `No`<br/>
각 사람이 가진 Lion 모델의 값을 활용하면 되겠죠?<br/>
Lion 모델에 어떤 칼럼이 있었죠? 이름(name)과 <Strong>PK(Primary Key)</Strong>가 있었죠 <br/><br/>

PK는 위에서 말한것처럼 그냥 객체 별 순번을 지정해준 것인데 <Strong>주요키</Strong>라고 불리는 이유는 <br/>
이름은 동명이인이 있거나 철자가 틀려서 잘못 될 수 있는데<br/>
PK는 유일성, 무결성등을 만족하기 때문에 PK를 활용해주는 것이 좋아요(순서도 order 되어잇구요)<br/>

그러면 사람별로 페이지를 렌더해주기 위해서는 우선 url을 수정해야겠죠?
```python
# myproject/urls.py
# 특별히 post/urls에서 안해준 이유는 없고 귀찮아서 걍 여따가 했음

from django.contrib import admin
from django.urls import path, include
import myapp.views

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', myapp.views.index, name = 'home'),
    path('lions/', myapp.views.lion_list, name = 'lions'),
    path('lions/<int:pk>', myapp.views.lion_posts, name = 'lion_posts'), # 추가
    path('post/', include('post.urls'))
]

```
보시면 기존에 lion 객체들을 render해주는 url 뒤에 `<int:pk>`라는 것이 붙었죠?<br/>
`path('lions/<int:pk>', myapp.views.post_list, name = 'lion_posts')`<br/>
이렇게 해주면 `http://127.0.0.1:8000/lions/1`내가 이런식의 url을 입력하면<br/>
1이라는 값이 integer(정수) pk 값에 저장되고 views.py 에서 사용할 수 있어요 <br/>
```python
#myapp(firstapp)/views.py

def lion_posts(request, pk): # pk 를 받아서 처리해주니 인자에 pk를 추가해주고
    
    post_pk = pk                                # post_pk 에 넘겨받은 pk를 저장
    author = Lion.objects.get(pk = post_pk)     # 작성자를 Lion model의 해당 pk를 가진 사람 가져와
    post_list = Post.objects.all().filter(name = author)
    # 게시글을 Post model의 해당 작성자를 가진 게시물들 가져와
    
    return render(request, 'lion_posts.html', { # 만든 변수들 넘겨주기
        'post_list' : post_list,
        'author' : author,
        'post_pk' : pk,
        })

```
이제 html만 만들어주면 되겠죠 ??<br/>
views.py 에서 넘겨준 author, post_pk, post_list를 사용해주시면 됩니다<br/>

```html
<body>
    
    <div class = "header">
        <h1>{{author}}님이 작성한 Post들 입니다</h1>
    </div>
    <div>
        <a href = "{% url 'lions' %}">뒤로가기</a>
    </div>
    
    <div class = "list">
    {% if post_list %}
    
        {% for post in post_list %}
            <div class = "post">
                
                <div class = "post_container">
                    
                    <div class = "post_header">
                        <h2>{{post.pk}}번째 포스트 입니다</h2>
                        <p>작성자 : {{post.name}}<p>    
                    </div>
                    
                    <div class = "post_center">
                        <p>제목 : {{post.title}}</p>
                        <p>내용 : {{post.content}}</p>
                    </div>
                    
                    <div class = "post_bottom">
                        <p>작성시각 : {{post.create_data}}</p>
                    </div>
                    
                </div>
            </div>
        {% endfor %}
    
    {% else %}
    
        <h2>작성된 Post가 없습니다</h2>
    
    {% endif %}
    
    </div>
</body>
```
#### 10) lions.html anchor tag 수정해주기
저번시간에 for 문으로 Lion 모델에 있는 객체들을 전부 html 에 나타내봤죠?<br/>
그러면 이제 각 사람의 이름은 눌르면 해당 페이지에 가도록 하여 개인의 게시물이 나타나도록 해볼게요
```html
    {% for lion in lion_list %}
        <div class = "lion">
            <h1><a href="{% url 'lion_posts' pk=lion.pk %}">{{ lion.name }}</a></h1>
            <p>가입 날짜 : {{ lion.create_data }}</p>
        </div>
    {% endfor %}
```
`<a href="{% url 'lion_posts' pk=lion.pk %}"> </a>`<br/>
원래 우리가 기존에 해주던 `<a href = "{% url <url_name> %}">` 이거에 pk만 추가해주면 됩니다<br/>
`<a href = "{% url <url_name> pk=lion.pk %}">` 이렇게여 <br/>
왜 pk = lion.pk 인지는 본인이 생각해보시길 바랄게용 <br/>

#### 11 ) Post를 form으로 입력해서 DB에 저장하기
form으로 입력받은 값을 model에 저장하기 위해서는 <strong>ModelForm<strong/>을 알아야 해요<br/>
ModelForm이란 form 과 그 폼을 이용하여 내가 저장할 Model을 연결시켜주는 애인데요<br/>
`역시 궁금하면 django 공식문서나 구글링을 추천`<br/>
일단 해볼게요<br/><br/>
startapp으로 app을 만들면 forms.py가 만들어지지 않을꺼에요, app내부에 forms.py 를 만들고<br/>
modelform을 작성해 볼게요<br/>
![asgsaeg](https://user-images.githubusercontent.com/48672212/79677293-a794b700-822a-11ea-8d37-487d574b0025.JPG)
```python
# myapp/forms.py

from django import forms        # django에서 forms import 해
from post.models import Post    # 저장할 모델 가져와

class PostForm(forms.ModelForm):    # django에서 forms.ModelForm를 상속받는다
    class Meta:
        model = Post                      # 저장하기를 원하는 데이터 모델 지정
        fields = ['title','content']
        
```

<br/>
ModelForm이 궁금하니 한번 Ctrl + 좌클릭으로 들어가볼게요 <br/>
![asgsaegg](https://user-images.githubusercontent.com/48672212/79677338-2b4ea380-822b-11ea-9994-513ba3f2757c.JPG)
<br/>
보시면 model과 fields 변수가 있죠? <br/>
우선은 model엔 내가 form 과 연결할 모델을 넣어주고<br/>
fields 값엔 해당 모델에서 내가 form 을 통해 값을 넣어줄 칼럼을 작성해줄게요<br/>
